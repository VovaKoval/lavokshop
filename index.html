<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LaVok CRM ‚Äî —Ñ—ñ–Ω–∞–ª—å–Ω–∞ –≤–µ—Ä—Å—ñ—è</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa4b2;--accent:#06b6d4;--danger:#ef4444;--success:#10b981}
    *{box-sizing:border-box}
    body{font-family:Inter,Roboto,Arial,sans-serif;background:linear-gradient(180deg,#071021 0%,#071a2a 100%);color:#e6eef6;padding:18px;margin:0}
    .wrap{max-width:1400px;margin:0 auto}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:18px}
    @media(max-width:1024px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 20px rgba(2,6,23,.6);margin-bottom:12px}
    .products{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
    .p{padding:12px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border:1px solid rgba(255,255,255,0.05)}
    button{background:var(--accent);color:#052025;padding:8px 14px;border-radius:8px;border:0;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.2s}
    button:hover{opacity:0.9;transform:translateY(-1px)}
    button.danger{background:var(--danger);color:#fff}
    button.success{background:var(--success);color:#fff}
    .muted{color:var(--muted);font-size:13px}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    .nowrap{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    input,select,textarea{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.02);color:inherit;width:100%;font-size:14px}
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--accent)}
    .cols{display:flex;gap:8px;flex-wrap:wrap}
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px;font-weight:500}
    .small{font-size:13px;color:var(--muted)}
    .tabs{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
    .tab{padding:10px 16px;border-radius:8px;background:rgba(255,255,255,0.02);cursor:pointer;font-weight:500;transition:all 0.2s}
    .tab:hover{background:rgba(255,255,255,0.05)}
    .active{background:linear-gradient(90deg,var(--accent),#07aab8);color:#042021}
    .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .right{margin-left:auto}
    .mini{padding:6px 10px;font-size:13px;border-radius:6px}
    .card-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px}
    .list-item{padding:12px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:8px;border:1px solid rgba(255,255,255,0.05)}
    .field-row{display:grid;gap:8px;grid-template-columns:1fr 1fr}
    .badge{display:inline-block;padding:4px 8px;border-radius:6px;font-size:12px;font-weight:500}
    .badge-cat{background:rgba(6,182,212,0.2);color:var(--accent)}
    .badge-stock{background:rgba(16,185,129,0.2);color:var(--success)}
    .modal-overlay{position:fixed;inset:0;background:rgba(2,6,23,0.8);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px}
    .modal-content{width:90%;max-width:800px;max-height:90vh;overflow-y:auto}
    .cart-item{display:flex;justify-content:space-between;align-items:center;padding:8px;background:rgba(255,255,255,0.02);border-radius:6px;margin-bottom:6px}
    .progress-bar{width:100%;height:24px;background:rgba(255,255,255,0.05);border-radius:12px;overflow:hidden;position:relative}
    .progress-fill{height:100%;background:linear-gradient(90deg,var(--accent),#07aab8);transition:width 0.3s;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600;color:#042021}
    .filters{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:8px;margin-bottom:12px}
    .checkbox-list{max-height:300px;overflow-y:auto;border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:8px}
    .checkbox-item{padding:6px;display:flex;align-items:center;gap:8px}
    .checkbox-item:hover{background:rgba(255,255,255,0.02);border-radius:4px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h2>üöÄ LaVok CRM</h2>
      <div class="flex">
        <button id="btnCart" class="mini">üõí –ö–æ—à–∏–∫ (<span id="cartCount">0</span>)</button>
        <button id="btnAddManual" class="mini">‚ûï –î–æ–¥–∞—Ç–∏ —Ç–æ–≤–∞—Ä</button>
      </div>
    </div>

    <div class="tabs card" id="mainTabs">
      <div class="tab active" data-tab="products">üì¶ –¢–æ–≤–∞—Ä–∏</div>
      <div class="tab" data-tab="orders">üõçÔ∏è –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è</div>
      <div class="tab" data-tab="clients">üë• –ö–ª—ñ—î–Ω—Ç–∏</div>
      <div class="tab" data-tab="receipts">üßæ –ß–µ–∫–∏</div>
    </div>

    <div class="grid">
      <div>
        <!-- Products -->
        <div class="card" id="viewProducts">
          <div class="card-title">
            <h3>üì¶ –¢–æ–≤–∞—Ä–∏</h3>
          </div>
          
          <div style="margin-bottom:12px">
            <input type="file" id="xmlfile" accept="text/xml,application/xml" style="display:none" />
            <button id="btnUploadXml">üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ XML</button>
            <span class="muted" style="margin-left:8px">–í–∏–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª –¥–ª—è —ñ–º–ø–æ—Ä—Ç—É</span>
          </div>

          <div class="filters">
            <input id="search" placeholder="üîç –ü–æ—à—É–∫ –ø–æ –Ω–∞–∑–≤—ñ / SKU" />
            <select id="filterCategory"><option value="">–í—Å—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</option></select>
            <select id="filterSupplier"><option value="">–í—Å—ñ –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫–∏</option></select>
            <input id="filterPriceMin" type="number" placeholder="–¶—ñ–Ω–∞ –≤—ñ–¥" />
            <input id="filterPriceMax" type="number" placeholder="–¶—ñ–Ω–∞ –¥–æ" />
            <button id="btnResetFilters" class="mini">üîÑ –°–∫–∏–Ω—É—Ç–∏</button>
          </div>

          <div id="products" class="products"></div>
        </div>

        <!-- Orders -->
        <div class="card" id="viewOrders" style="display:none">
          <div class="card-title">
            <h3>üõçÔ∏è –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è</h3>
            <button id="btnCreateOrder" class="mini">‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</button>
          </div>
          <div id="ordersList"></div>
        </div>

        <!-- Clients -->
        <div class="card" id="viewClients" style="display:none">
          <div class="card-title">
            <h3>üë• –ö–ª—ñ—î–Ω—Ç–∏</h3>
            <button id="btnAddClient" class="mini">‚ûï –î–æ–¥–∞—Ç–∏ –∫–ª—ñ—î–Ω—Ç–∞</button>
          </div>
          <div id="clientsList"></div>
        </div>

        <!-- Receipts -->
        <div class="card" id="viewReceipts" style="display:none">
          <div class="card-title"><h3>üßæ –ß–µ–∫–∏</h3></div>
          <div id="receiptsList"></div>
        </div>
      </div>

      <!-- Sidebar -->
      <div>
        <div class="card">
          <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
          <div class="small" style="margin:8px 0">–¢–æ–≤–∞—Ä—ñ–≤: <strong id="infoProducts">0</strong></div>
          <div class="small" style="margin:8px 0">–ó–∞–º–æ–≤–ª–µ–Ω—å: <strong id="infoOrders">0</strong></div>
          <div class="small" style="margin:8px 0">–ö–ª—ñ—î–Ω—Ç—ñ–≤: <strong id="infoClients">0</strong></div>
          <div class="small" style="margin:8px 0">–ß–µ–∫—ñ–≤: <strong id="infoReceipts">0</strong></div>
        </div>
      </div>
    </div>
  </div>

  <div id="modalArea"></div>

<script>
/* IndexedDB */
const DB = { name: 'lavok_crm_v2', version: 2, db: null };
function openDB(){
  return new Promise((res,rej)=>{
    const r = indexedDB.open(DB.name, DB.version);
    r.onupgradeneeded = e => {
      const db = e.target.result;
      if(!db.objectStoreNames.contains('products')){
        const ps = db.createObjectStore('products', { keyPath: 'id' });
        ps.createIndex('sku', 'sku', { unique: false });
        ps.createIndex('category', 'category', { unique: false });
      }
      if(!db.objectStoreNames.contains('clients')){
        db.createObjectStore('clients', { keyPath: 'id' });
      }
      if(!db.objectStoreNames.contains('orders')){
        db.createObjectStore('orders', { keyPath: 'id' });
      }
      if(!db.objectStoreNames.contains('receipts')){
        db.createObjectStore('receipts', { keyPath: 'id' });
      }
    };
    r.onsuccess = e => { DB.db = e.target.result; res(DB.db); };
    r.onerror = e => rej(e.target.error);
  });
}
function put(store, val){ return new Promise((res,rej)=>{ const request = DB.db.transaction(store,'readwrite').objectStore(store).put(val); request.onsuccess = ()=>res(request.result); request.onerror = ()=>rej(request.error); }); }
function get(store, key){ return new Promise((res,rej)=>{ const r = DB.db.transaction(store,'readonly').objectStore(store).get(key); r.onsuccess = ()=>res(r.result); r.onerror = ()=>rej(r.error); }); }
function getAll(store){ return new Promise((res,rej)=>{ const r = DB.db.transaction(store,'readonly').objectStore(store).getAll(); r.onsuccess = ()=>res(r.result||[]); r.onerror = ()=>rej(r.error); }); }
function deleteKey(store, key){ return new Promise((res,rej)=>{ const r = DB.db.transaction(store,'readwrite').objectStore(store).delete(key); r.onsuccess = ()=>res(); r.onerror = ()=>rej(r.error); }); }

/* Category rules - –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü—ñ—è */
const CATEGORY_RULES = {
  "–ß–æ—Ö–ª–∏": ["—á–æ—Ö–æ–ª","—á–µ—Ö–æ–ª","case","–∫–µ–π—Å","cover","–ø—Ä–æ—Ç–µ–∫—Ç–æ—Ä","–±–∞–º–ø–µ—Ä","–Ω–∞–∫–ª–∞–¥–∫–∞"],
  "–°–∫–ª–æ": ["—Å–∫–ª–æ","glass","tempered","protective","screen protector","—Å–∫—Ä–∏–Ω","–∑–∞—Ö–∏—Å–Ω–µ"],
  "–ó–∞—Ä—è–¥–Ω—ñ –ø—Ä–∏—Å—Ç—Ä–æ—ó": ["–∑–∞—Ä—è–¥","charger","adapter","–∑–∞—Ä—è–¥–Ω–∏–π","–±–ª–æ–∫ –∂–∏–≤–ª–µ–Ω–Ω—è","power adapter","–∫–∞–±–µ–ª—å","–ø—Ä–æ–≤—ñ–¥","usb","type-c","lightning","micro"],
  "–ë–µ–∑–¥—Ä–æ—Ç–æ–≤—ñ –∑–∞—Ä—è–¥–∫–∏": ["–±–µ–∑–¥—Ä–æ—Ç–æ–≤","wireless","magsafe","qi","magnetic","—ñ–Ω–¥—É–∫—Ü—ñ—è"],
  "–ü–æ–≤–µ—Ä–±–∞–Ω–∫–∏": ["powerbank","power bank","–∞–∫—É–º—É–ª—è—Ç–æ—Ä","–ø–æ–≤–µ—Ä–±–∞–Ω–∫","–∑–æ–≤–Ω—ñ—à–Ω—ñ–π","external battery","mah"],
  "–ù–∞–≤—É—à–Ω–∏–∫–∏": ["tws","airpods","bluetooth","–Ω–∞–≤—É—à–Ω–∏–∫","earbuds","headphone","–±–µ–∑–ø—Ä–æ–≤—ñ–¥","–¥—Ä–æ—Ç–æ–≤"],
  "–ö–æ–ª–æ–Ω–∫–∏": ["speaker","–∫–æ–ª–æ–Ω–∫","bluetooth speaker","–¥–∏–Ω–∞–º—ñ–∫","–∑–≤—É–∫"],
  "–ü–ª–∞–Ω—à–µ—Ç–∏": ["tablet","ipad","–ø–ª–∞–Ω—à–µ—Ç","tab"],
  "–ù–æ—É—Ç–±—É–∫–∏": ["laptop","notebook","macbook","–Ω–æ—É—Ç–±—É–∫"],
  "–ö–æ–º–ø'—é—Ç–µ—Ä–∏": ["desktop","pc","–∫–æ–º–ø'—é—Ç–µ—Ä","—Å–∏—Å—Ç–µ–º–Ω–∏–π –±–ª–æ–∫"],
  "–ì–æ–¥–∏–Ω–Ω–∏–∫–∏": ["watch","smartwatch","–≥–æ–¥–∏–Ω–Ω–∏–∫","band","–±—Ä–∞—Å–ª–µ—Ç"],
  "–ö—É—Ö–æ–Ω–Ω—ñ –ø—Ä–∏–ª–∞–¥–∏": ["–±–ª–µ–Ω–¥–µ—Ä","–º—ñ–∫—Å–µ—Ä","–º—É–ª—å—Ç–∏–≤–∞—Ä","—á–∞–π–Ω–∏–∫","—Ç–æ—Å—Ç–µ—Ä","–∫–∞–≤–æ–≤–∞—Ä","—Å–æ–∫–æ–≤–∏–∂–∏–º–∞–ª"],
  "–ü–æ–±—É—Ç–æ–≤–∞ —Ç–µ—Ö–Ω—ñ–∫–∞": ["–ø–∏–ª–æ—Å–æ—Å","–ø—Ä–∞–ª—å–Ω","–ø—Ä–∞—Å–∫–∞","—Å—É—à–∞—Ä–∫–∞","—Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫","–º—ñ–∫—Ä–æ—Ö–≤–∏–ª—å–æ–≤"],
  "–û—Å–≤—ñ—Ç–ª–µ–Ω–Ω—è": ["–ª–∞–º–ø–∞","—Å–≤—ñ—Ç–∏–ª—å–Ω–∏–∫","–ª—ñ—Ö—Ç–∞—Ä","led","–≥—ñ—Ä–ª—è–Ω–¥"],
  "–Ü–≥—Ä–∞—à–∫–∏": ["—ñ–≥—Ä–∞—à–∫","toy","–ª—è–ª—å–∫–∞"],
  "–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏": ["–¥—Ä–µ–ª—å","—ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç","–±–æ–ª–≥–∞—Ä–∫"],
  "–ê–≤—Ç–æ": ["–∞–≤—Ç–æ","car","—Ç—Ä–∏–º–∞—á"],
  "–°–ø–æ—Ä—Ç": ["—Å–ø–æ—Ä—Ç","—Ñ—ñ—Ç–Ω–µ—Å","–π–æ–≥–∞"],
  "–Ü–Ω—à–µ": []
};

function categorizeProduct(product){
  const text = `${product.title||''} ${product.description||''} ${product.sku||''}`.toLowerCase();
  for(const [cat, keywords] of Object.entries(CATEGORY_RULES)){
    for(const kw of keywords){
      if(text.includes(kw.toLowerCase())) return cat;
    }
  }
  return "–Ü–Ω—à–µ";
}

/* Cart */
let CART = [];

function addToCart(product){
  const existing = CART.find(item => item.id === product.id);
  if(existing){
    existing.quantity++;
  } else {
    CART.push({...product, quantity: 1});
  }
  updateCartCount();
  showNotification('‚úÖ –î–æ–¥–∞–Ω–æ –¥–æ –∫–æ—à–∏–∫–∞');
}

function removeFromCart(productId){
  CART = CART.filter(item => item.id !== productId);
  updateCartCount();
}

function updateCartCount(){
  document.getElementById('cartCount').textContent = CART.reduce((sum, item) => sum + item.quantity, 0);
}

function showCartModal(){
  if(CART.length === 0){
    alert('–ö–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π');
    return;
  }

  let html = '<h3>üõí –ö–æ—à–∏–∫</h3><div style="max-height:400px;overflow-y:auto;margin-bottom:12px">';
  let total = 0;
  
  CART.forEach(item => {
    const itemTotal = (item.price || 0) * item.quantity;
    total += itemTotal;
    html += `<div class="cart-item">
      <div style="flex:1">
        <div><strong>${item.title}</strong></div>
        <div class="small">${item.price}‚Ç¥ √ó ${item.quantity} = ${itemTotal}‚Ç¥</div>
      </div>
      <div style="display:flex;gap:4px">
        <button class="mini" onclick="changeCartQty('${item.id}',-1)">‚àí</button>
        <button class="mini" onclick="changeCartQty('${item.id}',1)">+</button>
        <button class="mini danger" onclick="removeFromCart('${item.id}');showCartModal()">√ó</button>
      </div>
    </div>`;
  });
  
  html += `</div><div style="font-size:18px;font-weight:bold;margin-bottom:12px">–í—Å—å–æ–≥–æ: ${total}‚Ç¥</div>`;
  html += '<button id="checkoutBtn" class="success" style="width:100%;padding:12px">–û—Ñ–æ—Ä–º–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</button>';
  
  showModal(html);
  
  document.getElementById('checkoutBtn').onclick = () => {
    closeModal();
    createOrderFromCart();
  };
}

function changeCartQty(productId, delta){
  const item = CART.find(i => i.id === productId);
  if(item){
    item.quantity += delta;
    if(item.quantity <= 0){
      removeFromCart(productId);
    }
  }
  updateCartCount();
}

/* Utils */
function uid(prefix='id'){ return prefix + '-' + Date.now() + '-' + Math.random().toString(36).slice(2,8); }
function formatPrice(v){ return (Number(v)||0).toFixed(2) + ' ‚Ç¥'; }
function showNotification(msg){
  const div = document.createElement('div');
  div.style.cssText = 'position:fixed;top:20px;right:20px;background:var(--success);color:#fff;padding:12px 20px;border-radius:8px;z-index:10000;animation:slideIn 0.3s';
  div.textContent = msg;
  document.body.appendChild(div);
  setTimeout(() => div.remove(), 3000);
}

/* Rendering */
async function renderProducts(){
  const el = document.getElementById('products');
  el.innerHTML = '';
  
  const search = document.getElementById('search').value.toLowerCase();
  const catFilter = document.getElementById('filterCategory').value;
  const supplierFilter = document.getElementById('filterSupplier').value;
  const priceMin = parseFloat(document.getElementById('filterPriceMin').value) || 0;
  const priceMax = parseFloat(document.getElementById('filterPriceMax').value) || 999999;
  
  let products = await getAll('products');
  
  products = products.filter(p => {
    if(search && !`${p.title} ${p.sku}`.toLowerCase().includes(search)) return false;
    if(catFilter && p.category !== catFilter) return false;
    if(supplierFilter && p.supplier !== supplierFilter) return false;
    if(p.price < priceMin || p.price > priceMax) return false;
    return true;
  });
  
  products.sort((a,b) => a.title.localeCompare(b.title));
  
  for(const p of products){
    const d = document.createElement('div');
    d.className = 'p';
    d.innerHTML = `
      <div style="margin-bottom:8px">
        ${p.image ? `<img src="${p.image}" style="width:100%;height:160px;object-fit:cover;border-radius:8px;margin-bottom:8px"/>` : '<div style="height:160px;background:rgba(255,255,255,0.02);border-radius:8px;display:flex;align-items:center;justify-content:center;margin-bottom:8px">üì¶</div>'}
        <div style="margin-bottom:4px">
          ${p.link ? `<a href="${p.link}" target="_blank" style="font-weight:600;font-size:15px">${p.title}</a>` : `<strong style="font-size:15px">${p.title}</strong>`}
        </div>
        <div class="muted nowrap" style="margin-bottom:4px">üè™ ${p.supplier||'‚Äî'}</div>
        <div style="display:flex;gap:4px;margin-bottom:8px;flex-wrap:wrap">
          <span class="badge badge-cat">${p.category||'‚Äî'}</span>
          <span class="badge-stock">SKU: ${p.sku||'‚Äî'}</span>
        </div>
        <div style="font-size:20px;font-weight:bold;color:var(--accent);margin-bottom:8px">${formatPrice(p.price)}</div>
        <div class="cols">
          <button class="mini" style="flex:1" onclick="addToCart(${JSON.stringify(p).replace(/"/g,'&quot;')})">üõí –í –∫–æ—à–∏–∫</button>
          <button class="mini" style="flex:1" onclick="editProduct('${p.id}')">‚úèÔ∏è –ó–º—ñ–Ω–∏—Ç–∏</button>
        </div>
      </div>`;
    el.appendChild(d);
  }
  
  await updateFilters();
  await updateStats();
}

async function updateFilters(){
  const products = await getAll('products');
  
  // Categories
  const cats = [...new Set(products.map(p => p.category).filter(Boolean))].sort();
  const catSel = document.getElementById('filterCategory');
  const currentCat = catSel.value;
  catSel.innerHTML = '<option value="">–í—Å—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</option>';
  cats.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = c;
    catSel.appendChild(opt);
  });
  catSel.value = currentCat;
  
  // Suppliers
  const suppliers = [...new Set(products.map(p => p.supplier).filter(Boolean))].sort();
  const suppSel = document.getElementById('filterSupplier');
  const currentSupp = suppSel.value;
  suppSel.innerHTML = '<option value="">–í—Å—ñ –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫–∏</option>';
  suppliers.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s;
    opt.textContent = s;
    suppSel.appendChild(opt);
  });
  suppSel.value = currentSupp;
}

async function renderOrders(){
  const el = document.getElementById('ordersList');
  el.innerHTML = '';
  const orders = (await getAll('orders')).sort((a,b) => (b.createdAt||'').localeCompare(a.createdAt||''));
  
  for(const o of orders){
    const d = document.createElement('div');
    d.className = 'list-item';
    d.innerHTML = `
      <div style="display:flex;justify-content:space-between;margin-bottom:8px">
        <div>
          <strong>–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è #${o.id.slice(-8)}</strong>
          <div class="small">${new Date(o.createdAt).toLocaleString('uk-UA')}</div>
        </div>
        <div style="text-align:right">
          <div style="font-size:18px;font-weight:bold;color:var(--accent)">${formatPrice(o.total)}</div>
        </div>
      </div>
      <div class="small" style="margin-bottom:8px">
        üë§ ${o.customerName} ‚Ä¢ üìû ${o.customerPhone}
      </div>
      <div style="margin-bottom:8px">
        <strong>–¢–æ–≤–∞—Ä–∏:</strong>
        ${o.items.map(item => `<div class="small">‚Ä¢ ${item.title} √ó ${item.quantity} = ${formatPrice(item.price * item.quantity)}</div>`).join('')}
      </div>
      <div class="cols">
        <button class="mini" onclick="viewReceipt('${o.id}')">üßæ –ß–µ–∫</button>
        <button class="mini danger" onclick="deleteOrder('${o.id}')">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏</button>
      </div>`;
    el.appendChild(d);
  }
  
  await updateStats();
}

async function renderClients(){
  const el = document.getElementById('clientsList');
  el.innerHTML = '';
  const clients = (await getAll('clients')).sort((a,b) => (b.totalSpent||0) - (a.totalSpent||0));
  
  for(const c of clients){
    const d = document.createElement('div');
    d.className = 'list-item';
    const avgCheck = c.totalOrders > 0 ? (c.totalSpent / c.totalOrders).toFixed(2) : 0;
    d.innerHTML = `
      <div style="display:flex;justify-content:space-between">
        <div style="flex:1">
          <div style="font-weight:600;font-size:15px">${c.name}</div>
          <div class="small">üìû ${c.phone}</div>
          ${c.email ? `<div class="small">üìß ${c.email}</div>` : ''}
          <div class="small" style="margin-top:4px">
            üõçÔ∏è –ó–∞–º–æ–≤–ª–µ–Ω—å: ${c.totalOrders||0} ‚Ä¢ üí∞ –°—É–º–∞: ${formatPrice(c.totalSpent||0)} ‚Ä¢ üìä –°–µ—Ä–µ–¥–Ω—ñ–π —á–µ–∫: ${avgCheck}‚Ç¥
          </div>
        </div>
        <div>
          <button class="mini" onclick="viewClient('${c.id}')">üëÅÔ∏è –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏</button>
        </div>
      </div>`;
    el.appendChild(d);
  }
  
  await updateStats();
}

async function renderReceipts(){
  const el = document.getElementById('receiptsList');
  el.innerHTML = '';
  const receipts = (await getAll('receipts')).sort((a,b) => (b.createdAt||'').localeCompare(a.createdAt||''));
  
  for(const r of receipts){
    const d = document.createElement('div');
    d.className = 'list-item';
    d.innerHTML = `
      <div style="display:flex;justify-content:space-between">
        <div>
          <strong>–ß–µ–∫ #${r.id.slice(-8)}</strong>
          <div class="small">${new Date(r.createdAt).toLocaleString('uk-UA')}</div>
          <div class="small">üë§ ${r.customerName} ‚Ä¢ üìû ${r.customerPhone}</div>
          <div class="small" style="color:var(--accent)">üí∞ ${formatPrice(r.total)}</div>
        </div>
        <div>
          <button class="mini" onclick="downloadReceiptPDF('${r.id}')">üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
        </div>
      </div>`;
    el.appendChild(d);
  }
  
  await updateStats();
}

async function updateStats(){
  document.getElementById('infoProducts').textContent = (await getAll('products')).length;
  document.getElementById('infoOrders').textContent = (await getAll('orders')).length;
  document.getElementById('infoClients').textContent = (await getAll('clients')).length;
  document.getElementById('infoReceipts').textContent = (await getAll('receipts')).length;
}

/* Modals */
function showModal(html){
  const area = document.getElementById('modalArea');
  area.innerHTML = `<div class="modal-overlay" id="modalOverlay"><div class="modal-content"><div class="card">${html}</div></div></div>`;
  document.getElementById('modalOverlay').onclick = e => {
    if(e.target.id === 'modalOverlay') closeModal();
  };
}

function closeModal(){
  document.getElementById('modalArea').innerHTML = '';
}

/* Product operations */
function addManualProduct(){
  showModal(`<h3>‚ûï –î–æ–¥–∞—Ç–∏ —Ç–æ–≤–∞—Ä –≤—Ä—É—á–Ω—É</h3>
    <div class="field-row"><div><label>–ù–∞–∑–≤–∞ *</label><input id="m_title"></div><div><label>SKU</label><input id="m_sku"></div></div>
    <div class="field-row" style="margin-top:8px"><div><label>–¶—ñ–Ω–∞ *</label><input id="m_price" type="number"></div><div><label>–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫</label><input id="m_supplier"></div></div>
    <div style="margin-top:8px"><label>–ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Ç–æ–≤–∞—Ä</label><input id="m_link"></div>
    <div style="margin-top:8px"><label>–ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Ñ–æ—Ç–æ</label><input id="m_image"></div>
    <div style="margin-top:8px"><label>–û–ø–∏—Å</label><textarea id="m_desc" rows="3"></textarea></div>
    <div style="margin-top:12px"><button id="m_save" class="success">–ó–±–µ—Ä–µ–≥—Ç–∏</button> <button onclick="closeModal()" class="mini">–°–∫–∞—Å—É–≤–∞—Ç–∏</button></div>`);
  
  document.getElementById('m_save').onclick = async () => {
    const title = document.getElementById('m_title').value.trim();
    const price = parseFloat(document.getElementById('m_price').value);
    
    if(!title || !price){
      alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –Ω–∞–∑–≤—É —Ç–∞ —Ü—ñ–Ω—É');
      return;
    }
    
    const product = {
      id: uid('p'),
      title,
      sku: document.getElementById('m_sku').value.trim() || uid('SKU'),
      price,
      supplier: document.getElementById('m_supplier').value.trim(),
      link: document.getElementById('m_link').value.trim(),
      image: document.getElementById('m_image').value.trim(),
      description: document.getElementById('m_desc').value.trim(),
      category: ''
    };
    product.category = categorizeProduct(product);
    await put('products', product);
    closeModal();
    showNotification('–¢–æ–≤–∞—Ä –∑–±–µ—Ä–µ–∂–µ–Ω–æ');
    await renderProducts();
  };
}

document.getElementById('btnUploadXml').onclick = () => {
  document.getElementById('xmlfile').click();
};

document.getElementById('xmlfile').onchange = async (e) => {
  const file = e.target.files[0];
  if(!file) return;
  const text = await file.text();
  const parser = new DOMParser();
  const xml = parser.parseFromString(text, "application/xml");
  
  // –ø–µ—Ä–µ–±—ñ—Ä —Ç–æ–≤–∞—Ä—ñ–≤ (–∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ XML)
  const items = xml.querySelectorAll('item'); // –ø—Ä–∏–∫–ª–∞–¥
  for(const i of items){
    const product = {
      id: uid('p'),
      title: i.querySelector('title')?.textContent || '–ë–µ–∑ –Ω–∞–∑–≤–∏',
      sku: i.querySelector('sku')?.textContent || uid('SKU'),
      price: parseFloat(i.querySelector('price')?.textContent) || 0,
      supplier: i.querySelector('supplier')?.textContent || '',
      link: i.querySelector('link')?.textContent || '',
      image: i.querySelector('image')?.textContent || '',
      description: i.querySelector('description')?.textContent || ''
    };
    product.category = categorizeProduct(product);
    await put('products', product);
  }
  await renderProducts();
  showNotification('–¢–æ–≤–∞—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –∑ XML');
};


async function editProduct(id){
  const p = await get('products', id);
  if(!p) return alert('–¢–æ–≤–∞—Ä –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');

  showModal(`<h3>‚úèÔ∏è –ó–º—ñ–Ω–∏—Ç–∏ —Ç–æ–≤–∞—Ä</h3>
    <div class="field-row"><div><label>–ù–∞–∑–≤–∞ *</label><input id="e_title" value="${(p.title||'').replace(/"/g,'&quot;')}"></div><div><label>SKU</label><input id="e_sku" value="${(p.sku||'').replace(/"/g,'&quot;')}"></div></div>
    <div class="field-row" style="margin-top:8px"><div><label>–¶—ñ–Ω–∞ *</label><input id="e_price" type="number" value="${p.price||0}"></div><div><label>–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫</label><input id="e_supplier" value="${(p.supplier||'').replace(/"/g,'&quot;')}"></div></div>
    <div style="margin-top:8px"><label>–ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Ç–æ–≤–∞—Ä</label><input id="e_link" value="${(p.link||'').replace(/"/g,'&quot;')}"></div>
    <div style="margin-top:8px"><label>–ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Ñ–æ—Ç–æ</label><input id="e_image" value="${(p.image||'').replace(/"/g,'&quot;')}"></div>
    <div style="margin-top:8px"><label>–û–ø–∏—Å</label><textarea id="e_desc" rows="3">${(p.description||'').replace(/</g,'&lt;')}</textarea></div>
    <div style="margin-top:12px"><button id="e_save" class="success">–ó–±–µ—Ä–µ–≥—Ç–∏</button> <button onclick="deleteProduct('${id}')" class="mini danger">–í–∏–¥–∞–ª–∏—Ç–∏</button> <button onclick="closeModal()" class="mini">–°–∫–∞—Å—É–≤–∞—Ç–∏</button></div>`);

  document.getElementById('e_save').onclick = async () => {
    const title = document.getElementById('e_title').value.trim();
    const price = parseFloat(document.getElementById('e_price').value);
    if(!title || !price){ alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –Ω–∞–∑–≤—É —Ç–∞ —Ü—ñ–Ω—É'); return; }

    p.title = title;
    p.sku = document.getElementById('e_sku').value.trim() || p.sku;
    p.price = price;
    p.supplier = document.getElementById('e_supplier').value.trim();
    p.link = document.getElementById('e_link').value.trim();
    p.image = document.getElementById('e_image').value.trim();
    p.description = document.getElementById('e_desc').value.trim();
    p.category = categorizeProduct(p);

    await put('products', p);
    closeModal();
    showNotification('–ó–º—ñ–Ω–µ–Ω–æ');
    await renderProducts();
  };
}

async function deleteProduct(id){
  if(!confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ç–æ–≤–∞—Ä?')) return;
  await deleteKey('products', id);
  closeModal();
  showNotification('–¢–æ–≤–∞—Ä –≤–∏–¥–∞–ª–µ–Ω–æ');
  await renderProducts();
}

/* Orders & Receipts */
async function createOrderFromCart(){
  const name = prompt('–Ü–º\'—è –ø–æ–∫—É–ø—Ü—è (–æ–±–æ–≤\'—è–∑–∫–æ–≤–æ):');
  if(!name) return alert('–Ü–º\'—è –æ–±–æ–≤\'—è–∑–∫–æ–≤–µ');
  const phone = prompt('–¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–∫—É–ø—Ü—è:') || '';

  const items = CART.map(i => ({ id: i.id, title: i.title, price: i.price, quantity: i.quantity }));
  const total = items.reduce((s,i)=>s + (i.price||0)*i.quantity, 0);
  const order = { id: uid('o'), createdAt: new Date().toISOString(), items, total, customerName: name, customerPhone: phone };
  await put('orders', order);

  // create receipt
  const receipt = { id: uid('r'), createdAt: new Date().toISOString(), items, total, customerName: name, customerPhone: phone, orderId: order.id };
  await put('receipts', receipt);

  // update/create client
  const clients = await getAll('clients');
  let client = clients.find(c => c.phone === phone && phone);
  if(!client){
    client = { id: uid('c'), name, phone, email: '', totalOrders: 1, totalSpent: total };
  } else {
    client.totalOrders = (client.totalOrders||0) + 1;
    client.totalSpent = (client.totalSpent||0) + total;
  }
  await put('clients', client);

  CART = [];
  updateCartCount();
  showNotification('–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–≤–æ—Ä–µ–Ω–æ');
  await renderOrders();
  await renderReceipts();
  await renderClients();
}

async function viewReceipt(orderId){
  const order = await get('orders', orderId);
  if(!order) return alert('–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
  const html = `<h3>üßæ –ß–µ–∫ ‚Äî ${order.customerName}</h3>
    <div class="small">–î–∞—Ç–∞: ${new Date(order.createdAt).toLocaleString('uk-UA')}</div>
    <div style="margin-top:8px">${order.items.map(it=>`<div class="small">‚Ä¢ ${it.title} √ó ${it.quantity} = ${formatPrice(it.price*it.quantity)}</div>`).join('')}</div>
    <div style="font-weight:700;margin-top:8px">–í—Å—å–æ–≥–æ: ${formatPrice(order.total)}</div>
    <div style="margin-top:12px" class="cols"><button class="success" onclick="downloadReceiptPDF('${order.id}')">üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ PDF</button> <button class="mini" onclick="closeModal()">–ó–∞–∫—Ä–∏—Ç–∏</button></div>`;
  showModal(html);
}

async function downloadReceiptPDF(receiptOrOrderId){
  // try receipts first, then orders
  let r = await get('receipts', receiptOrOrderId);
  if(!r){
    r = await get('orders', receiptOrOrderId);
  }
  if(!r) return alert('–ß–µ–∫ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(14);
  doc.text('LaVok ‚Äî –ß–µ–∫', 14, 20);
  doc.setFontSize(11);
  doc.text(`–ù–æ–º–µ—Ä: ${r.id}`, 14, 30);
  doc.text(`–î–∞—Ç–∞: ${new Date(r.createdAt).toLocaleString('uk-UA')}`, 14, 38);
  doc.text(`–ö–ª—ñ—î–Ω—Ç: ${r.customerName || ''} ${r.customerPhone ? ' ‚Ä¢ ' + r.customerPhone : ''}`, 14, 46);

  let y = 60;
  r.items.forEach(it => {
    const line = `${it.title} √ó ${it.quantity} ‚Äî ${formatPrice(it.price*it.quantity)}`;
    doc.text(line, 14, y);
    y += 8;
    if(y > 270){ doc.addPage(); y = 20; }
  });

  doc.setFontSize(12);
  doc.text(`–í—Å—å–æ–≥–æ: ${formatPrice(r.total)}`, 14, y + 8);

  doc.save(`chek_${r.id}.pdf`);
}

async function deleteOrder(id){
  if(!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è?')) return;
  await deleteKey('orders', id);
  showNotification('–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –≤–∏–¥–∞–ª–µ–Ω–æ');
  await renderOrders();
}

async function viewClient(id){
  const c = await get('clients', id);
  if(!c) return alert('–ö–ª—ñ—î–Ω—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∏–π');
  const html = `<h3>üë§ ${c.name}</h3>
    <div class="small">üìû ${c.phone}</div>
    <div class="small">üìß ${c.email||'‚Äî'}</div>
    <div class="small" style="margin-top:8px">üõçÔ∏è –ó–∞–º–æ–≤–ª–µ–Ω—å: ${c.totalOrders||0} ‚Ä¢ üí∞ –°—É–º–∞: ${formatPrice(c.totalSpent||0)}</div>
    <div style="margin-top:12px" class="cols"><button class="mini" onclick="closeModal()">–ó–∞–∫—Ä–∏—Ç–∏</button></div>`;
  showModal(html);
}

/* XML import */
function parseXmlProducts(xmlText){
  const parser = new DOMParser();
  const doc = parser.parseFromString(xmlText, 'application/xml');
  const items = [];
  const possible = ['item','product','offer','offer_item','good'];
  let nodes = [];
  for(const tag of possible){
    const n = Array.from(doc.getElementsByTagName(tag));
    if(n.length) nodes = nodes.concat(n);
  }
  // if none found, take any child of root
  if(nodes.length === 0){
    const root = doc.documentElement;
    nodes = Array.from(root.children);
  }

  nodes.forEach(node => {
    const read = name => {
      const el = node.getElementsByTagName(name)[0];
      return el ? el.textContent.trim() : '';
    };
    const title = read('title') || read('name') || read('product_name') || read('model') || read('full_name');
    const sku = read('sku') || read('id') || read('code') || read('article');
    let price = parseFloat(read('price') || read('cost') || read('price_usd')) || 0;
    if(!price){ // try attributes
      const priceAttr = node.getAttribute('price') || node.getAttribute('cost');
      price = parseFloat(priceAttr) || 0;
    }
    const description = read('description') || read('desc') || '';
    const image = read('image') || read('picture') || read('img') || '';
    const link = read('link') || read('url') || '';
    const supplier = read('vendor') || read('producer') || read('manufacturer') || '';

    if(title){
      items.push({ title, sku: sku || uid('SKU'), price: price || 0, description, image, link, supplier });
    }
  });
  return items;
}

async function importXmlFile(file){
  const text = await file.text();
  const parsed = parseXmlProducts(text);
  let count = 0;
  for(const it of parsed){
    const product = { id: uid('p'), ...it };
    product.category = categorizeProduct(product);
    await put('products', product);
    count++;
  }
  showNotification(`–Ü–º–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ ${count} —Ç–æ–≤–∞—Ä—ñ–≤`);
  await renderProducts();
}

/* UI wiring */
function setupUI(){
  document.getElementById('btnUploadXml').onclick = () => document.getElementById('xmlfile').click();
  document.getElementById('xmlfile').onchange = e => {
    const f = e.target.files[0];
    if(f) importXmlFile(f);
    e.target.value = '';
  };

  document.getElementById('btnAddManual').onclick = addManualProduct;
  document.getElementById('btnCart').onclick = showCartModal;

  // tabs
  document.querySelectorAll('#mainTabs .tab').forEach(tab => {
    tab.onclick = async () => {
      document.querySelectorAll('#mainTabs .tab').forEach(t=>t.classList.remove('active'));
      tab.classList.add('active');
      const tabName = tab.dataset.tab;
      document.getElementById('viewProducts').style.display = tabName === 'products' ? '' : 'none';
      document.getElementById('viewOrders').style.display = tabName === 'orders' ? '' : 'none';
      document.getElementById('viewClients').style.display = tabName === 'clients' ? '' : 'none';
      document.getElementById('viewReceipts').style.display = tabName === 'receipts' ? '' : 'none';
      if(tabName === 'orders') await renderOrders();
      if(tabName === 'clients') await renderClients();
      if(tabName === 'receipts') await renderReceipts();
    };
  });

  // filters/search
  ['search','filterCategory','filterSupplier','filterPriceMin','filterPriceMax'].forEach(id=>{
    document.getElementById(id).oninput = debounce(()=>renderProducts(), 300);
  });
  document.getElementById('btnResetFilters').onclick = () => {
    document.getElementById('search').value = '';
    document.getElementById('filterCategory').value = '';
    document.getElementById('filterSupplier').value = '';
    document.getElementById('filterPriceMin').value = '';
    document.getElementById('filterPriceMax').value = '';
    renderProducts();
  };

  document.getElementById('btnCreateOrder').onclick = async () => {
    // quick create empty order (for manual use)
    const products = await getAll('products');
    if(products.length === 0) return alert('–ù–µ–º–∞—î —Ç–æ–≤–∞—Ä—ñ–≤ –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è');
    const p = products[0];
    CART = [{ ...p, quantity: 1 }];
    showCartModal();
  };

  document.getElementById('btnAddClient').onclick = async () => {
    showModal(`<h3>‚ûï –î–æ–¥–∞—Ç–∏ –∫–ª—ñ—î–Ω—Ç–∞</h3>
      <div><label>–Ü–º\'—è</label><input id="c_name"></div>
      <div style="margin-top:8px"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input id="c_phone"></div>
      <div style="margin-top:8px"><label>Email</label><input id="c_email"></div>
      <div style="margin-top:12px"><button id="c_save" class="success">–ó–±–µ—Ä–µ–≥—Ç–∏</button> <button onclick="closeModal()" class="mini">–°–∫–∞—Å—É–≤–∞—Ç–∏</button></div>`);

    document.getElementById('c_save').onclick = async () => {
      const name = document.getElementById('c_name').value.trim();
      const phone = document.getElementById('c_phone').value.trim();
      const email = document.getElementById('c_email').value.trim();
      if(!name || !phone) return alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å —ñ–º\'—è —Ç–∞ —Ç–µ–ª–µ—Ñ–æ–Ω');
      const client = { id: uid('c'), name, phone, email, totalOrders:0, totalSpent:0 };
      await put('clients', client);
      closeModal();
      showNotification('–ö–ª—ñ—î–Ω—Ç–∞ –¥–æ–¥–∞–Ω–æ');
      await renderClients();
    };
  };
}

/* helpers */
function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t = setTimeout(()=>fn(...a), ms); }; }

/* Init */
(async function(){
  await openDB();
  setupUI();
  await renderProducts();
})();
</script>
</body>
</html>
