<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CRM –î—Ä–æ–ø—à–∏–ø—ñ–Ω–≥ ‚Äî –ø–æ–∫—Ä–∞—â–µ–Ω–∞ –≤–µ—Ä—Å—ñ—è</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<style>body{ -webkit-tap-highlight-color:transparent; } .modal-bg{background:rgba(0,0,0,0.45);}</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const {useState, useEffect} = React;

/*
  Simplified, robust single-file SPA that implements:
  - Visible filters panel (fixes "filters not visible" issue)
  - Manual Add Product form (when XML can't be uploaded)
  - XML import with category extraction and selection before import
  - Export / download of JSON backup
  This is a compact, tested implementation meant to replace the previous index UI for these features.
*/

function App(){
  const [products, setProducts] = useState([]);
  const [suppliers, setSuppliers] = useState([]);
  const [loading, setLoading] = useState(false);

  // Filters (always visible)
  const [q, setQ] = useState('');
  const [onlyAvailable, setOnlyAvailable] = useState('all'); // all/yes/no
  const [supplierFilter, setSupplierFilter] = useState('all');
  const [priceMin, setPriceMin] = useState('');
  const [priceMax, setPriceMax] = useState('');
  const [showAddModal, setShowAddModal] = useState(false);

  // XML import state
  const [xmlCategories, setXmlCategories] = useState([]);
  const [selectedCategories, setSelectedCategories] = useState([]);
  const [showCategoryModal, setShowCategoryModal] = useState(false);
  const [pendingXmlProducts, setPendingXmlProducts] = useState([]);
  const [pendingSupplierName, setPendingSupplierName] = useState('');

  useEffect(()=>{ // load saved
    try{
      const p = JSON.parse(localStorage.getItem('crm-products')||'[]');
      const s = JSON.parse(localStorage.getItem('crm-suppliers')||'[]');
      setProducts(p);
      setSuppliers(s);
    }catch(e){}
  },[]);

  useEffect(()=>{
    localStorage.setItem('crm-products', JSON.stringify(products));
    localStorage.setItem('crm-suppliers', JSON.stringify(suppliers));
  },[products,suppliers]);

  // --- FILTERING ---
  const filtered = products.filter(p=>{
    if(q && !(p.name||'').toLowerCase().includes(q.toLowerCase())) return false;
    if(supplierFilter !== 'all' && p.supplier !== supplierFilter) return false;
    const price = parseFloat(p.rrp||p.basePrice||0) || 0;
    if(priceMin && price < parseFloat(priceMin)) return false;
    if(priceMax && price > parseFloat(priceMax)) return false;
    if(onlyAvailable === 'yes' && !p.available) return false;
    if(onlyAvailable === 'no' && p.available) return false;
    return true;
  });

  // --- MANUAL ADD ---
  const openAdd = (prefill) => {
    setShowAddModal(true);
    setTimeout(()=> {
      const el = document.getElementById('add-name');
      if(el) el.focus();
    },100);
    if(prefill){
      // handled inside modal inputs by checking prefill prop
    }
  };

  const saveManualProduct = (prod) => {
    const p = {...prod, id: Date.now().toString()};
    setProducts(prev=>[p,...prev]);
    if(p.supplier && !suppliers.includes(p.supplier)){
      setSuppliers(prev=>[...new Set([p.supplier, ...prev])]);
    }
    setShowAddModal(false);
    alert('‚úÖ –¢–æ–≤–∞—Ä –¥–æ–¥–∞–Ω–æ –≤—Ä—É—á–Ω—É');
  };

  // --- XML PARSING & CATEGORY SELECTION ---
  const handleFile = async (e) => {
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    if(!file.name.toLowerCase().endsWith('.xml')){ alert('–û–±–µ—Ä—ñ—Ç—å XML —Ñ–∞–π–ª'); return; }
    setLoading(true);
    try{
      const text = await file.text();
      const parser = new DOMParser();
      const xml = parser.parseFromString(text,'text/xml');
      const offers = xml.getElementsByTagName('offer').length ? xml.getElementsByTagName('offer') :
                     xml.getElementsByTagName('item').length ? xml.getElementsByTagName('item') :
                     xml.getElementsByTagName('product').length ? xml.getElementsByTagName('product') : [];
      if(offers.length === 0) { alert('–£ XML –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ —Ç–æ–≤–∞—Ä—ñ–≤'); setLoading(false); return; }

      // map offers to lightweight product objects
      const arr = [];
      const cats = new Set();
      for(let i=0;i<offers.length;i++){
        const o = offers[i];
        const idAttr = o.getAttribute && (o.getAttribute('id')||o.getAttribute('offer-id')||o.getAttribute('offerId')) || `xml-${i}`;
        const name = o.getElementsByTagName('name')[0]?.textContent || o.getElementsByTagName('title')[0]?.textContent || '';
        const priceTxt = o.getElementsByTagName('price')[0]?.textContent || o.getElementsByTagName('priceRRC')[0]?.textContent || '0';
        const price = parseFloat(priceTxt.replace(/[^\d.,]/g,'').replace(',','.')) || 0;
        const vendor = o.getElementsByTagName('vendor')[0]?.textContent || o.getElementsByTagName('brand')[0]?.textContent || '';
        const pic = o.getElementsByTagName('picture')[0]?.textContent || o.getElementsByTagName('image')[0]?.textContent || '';
        const url = o.getElementsByTagName('url')[0]?.textContent || '';
        const cat = o.getElementsByTagName('category')[0]?.textContent || o.getElementsByTagName('categoryId')[0]?.textContent || vendor || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó';
        cats.add(cat);
        arr.push({
          id: `xml-${Date.now()}-${i}`,
          supplierCode: String(idAttr),
          name: (name||'').trim(),
          basePrice: Math.round(price*100)/100,
          rrp: Math.round(price*1.5*100)/100,
          available: true,
          supplier: file.name.replace(/\..+$/,''),
          vendor: vendor,
          image: pic,
          supplierUrl: url,
          category: cat,
        });
      }

      const supplierName = prompt('–í–≤–µ–¥–∏ –Ω–∞–∑–≤—É –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫–∞ –¥–ª—è —Ü–∏—Ö —Ç–æ–≤–∞—Ä—ñ–≤:', file.name.replace(/\..+$/,''));
      if(supplierName === null){ setLoading(false); return; }
      arr.forEach(a=>a.supplier = supplierName || a.supplier);

      // Save pending and show category selection
      setPendingXmlProducts(arr);
      const catArr = Array.from(cats).sort();
      setXmlCategories(catArr);
      setSelectedCategories(catArr.slice()); // default select all
      setPendingSupplierName(supplierName||file.name);
      setShowCategoryModal(true);
    }catch(err){
      console.error(err);
      alert('–ü–æ–º–∏–ª–∫–∞ —á–∏—Ç–∞–Ω–Ω—è XML');
    }finally{
      e.target.value = '';
      setLoading(false);
    }
  };

  const toggleCategory = (cat) => {
    setSelectedCategories(prev => prev.includes(cat) ? prev.filter(c=>c!==cat) : [...prev,cat]);
  };

  const importSelectedCategories = () => {
    const toImport = pendingXmlProducts.filter(p=> selectedCategories.includes(p.category));
    if(toImport.length === 0){ alert('–ù–µ –æ–±—Ä–∞–Ω–æ –∂–æ–¥–Ω–æ—ó –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó'); return; }
    // check duplicate by supplierCode and supplier
    const existing = new Set(products.map(p=> p.supplier+'|'+p.supplierCode));
    const newOnes = toImport.filter(p=> !existing.has(p.supplier+'|'+p.supplierCode));
    setProducts(prev=>[...newOnes, ...prev]);
    setSuppliers(prev=> [...new Set([pendingSupplierName, ...prev])]);
    setPendingXmlProducts([]);
    setShowCategoryModal(false);
    alert(`‚úÖ –Ü–º–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ ${newOnes.length} —Ç–æ–≤–∞—Ä—ñ–≤ (–æ–±—Ä–∞–Ω–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä—ñ–π).`);
  };

  // --- EXPORT / DOWNLOAD ---
  const downloadBackup = () => {
    const data = { products, suppliers, exportedAt: new Date().toISOString() };
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `crm-backup-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
  };

  // --- UI ---
  return (
    <div className="min-h-screen bg-gray-50 p-4">
      <header className="mb-4">
        <h1 className="text-2xl font-bold">üöÄ CRM –î—Ä–æ–ø—à–∏–ø—ñ–Ω–≥ ‚Äî –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø–∞–Ω–µ–ª—å —Ñ—ñ–ª—å—Ç—Ä—ñ–≤</h1>
        <p className="text-sm text-gray-600">–î–æ–¥–∞–Ω–æ: –≤–∏–¥–∏–º—ñ —Ñ—ñ–ª—å—Ç—Ä–∏, —Ä—É—á–Ω–µ –¥–æ–¥–∞–≤–∞–Ω–Ω—è —Ç–æ–≤–∞—Ä—ñ–≤, –≤–∏–±—ñ—Ä –∫–∞—Ç–µ–≥–æ—Ä—ñ–π –ø—Ä–∏ —ñ–º–ø–æ—Ä—Ç—ñ XML.</p>
      </header>

      <section className="mb-4 grid grid-cols-1 md:grid-cols-3 gap-3">
        <div className="col-span-2 bg-white p-3 rounded shadow">
          <div className="flex gap-2 mb-2">
            <label className="flex-1 bg-blue-600 text-white py-2 rounded text-center cursor-pointer">
              –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ XML
              <input type="file" accept=".xml" onChange={handleFile} className="hidden" />
            </label>
            <button className="bg-green-600 text-white py-2 px-3 rounded" onClick={()=>openAdd()}>–î–æ–¥–∞—Ç–∏ —Ç–æ–≤–∞—Ä</button>
            <button className="bg-gray-700 text-white py-2 px-3 rounded" onClick={downloadBackup}>–ï–∫—Å–ø–æ—Ä—Ç</button>
          </div>

          {/* Filters always visible (fix) */}
          <div className="bg-gray-50 p-3 rounded mb-3 border">
            <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
              <input placeholder="–ü–æ—à—É–∫..." className="p-2 border rounded" value={q} onChange={e=>setQ(e.target.value)} />
              <select className="p-2 border rounded" value={supplierFilter} onChange={e=>setSupplierFilter(e.target.value)}>
                <option value="all">–í—Å—ñ –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫–∏</option>
                {suppliers.map(s=> <option key={s} value={s}>{s}</option>)}
              </select>
              <select className="p-2 border rounded" value={onlyAvailable} onChange={e=>setOnlyAvailable(e.target.value)}>
                <option value="all">–í—Å—ñ –ø–æ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ</option>
                <option value="yes">‚úÖ –Ñ –≤ –Ω–∞—è–≤.</option>
                <option value="no">‚ùå –ù–µ–º–∞—î</option>
              </select>
              <div className="flex gap-1">
                <input className="p-2 border rounded w-full" placeholder="–º—ñ–Ω. —Ü—ñ–Ω–∞" value={priceMin} onChange={e=>setPriceMin(e.target.value)} />
                <input className="p-2 border rounded w-full" placeholder="–º–∞–∫—Å. —Ü—ñ–Ω–∞" value={priceMax} onChange={e=>setPriceMax(e.target.value)} />
              </div>
            </div>
          </div>

          <div>
            {loading ? (
              <div className="p-6 text-center">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
            ) : filtered.length === 0 ? (
              <div className="p-6 text-center text-gray-500">–¢–æ–≤–∞—Ä–∏ –≤—ñ–¥—Å—É—Ç–Ω—ñ</div>
            ) : (
              <div className="space-y-3">
                {filtered.map(p=>(
                  <div key={p.id} className="bg-white p-3 rounded shadow">
                    <div className="flex items-center gap-3">
                      <div className="w-20 h-20 bg-gray-100 rounded overflow-hidden flex items-center justify-center">
                        {p.image ? <img src={p.image} alt="" className="object-cover w-full h-full" onError={(e)=>e.target.style.display='none'} /> : <span className="text-sm text-gray-500">No image</span>}
                      </div>
                      <div className="flex-1">
                        <div className="font-semibold">{p.name || '(–ë–µ–∑ –Ω–∞–∑–≤–∏)'}</div>
                        <div className="text-xs text-gray-600">–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫: {p.supplier} | –ö–∞—Ç–µ–≥–æ—Ä—ñ—è: {p.category}</div>
                        <div className="mt-2 font-bold">{(p.rrp||p.basePrice||0).toFixed(2)} ‚Ç¥</div>
                      </div>
                      <div>
                        <button className="bg-yellow-500 text-white px-3 py-1 rounded mr-2" onClick={()=>{
                          const copy = {...p, id: Date.now().toString()};
                          setProducts(prev=>[copy,...prev]);
                          alert('–ö–ª–æ–Ω —Å—Ç–≤–æ—Ä–µ–Ω–æ');
                        }}>–ö–ª–æ–Ω</button>
                        <button className="bg-red-500 text-white px-3 py-1 rounded" onClick={()=>{
                          if(confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ç–æ–≤–∞—Ä?')) setProducts(prev=>prev.filter(x=>x.id!==p.id));
                        }}>–í–∏–¥–∞–ª–∏—Ç–∏</button>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>

        </div>

        <aside className="bg-white p-3 rounded shadow">
          <h3 className="font-semibold mb-2">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
          <div className="text-sm text-gray-700">–¢–æ–≤–∞—Ä—ñ–≤: <strong>{products.length}</strong></div>
          <div className="text-sm text-gray-700">–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫—ñ–≤: <strong>{suppliers.length}</strong></div>
          <div className="text-sm text-gray-700">–ü–æ—à—É–∫: <strong>{q? 'ON':'OFF'}</strong></div>
        </aside>
      </section>

      {/* CATEGORY SELECTION MODAL */}
      {showCategoryModal && (
        <div className="fixed inset-0 flex items-center justify-center modal-bg z-50">
          <div className="bg-white rounded w-11/12 md:w-2/3 p-4">
            <div className="flex justify-between items-center mb-3">
              <h3 className="font-bold">–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –¥–ª—è —ñ–º–ø–æ—Ä—Ç—É ({xmlCategories.length})</h3>
              <button onClick={()=>{setShowCategoryModal(false); setPendingXmlProducts([]);}}>–ó–∞–∫—Ä–∏—Ç–∏</button>
            </div>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-2 mb-3 max-h-64 overflow-auto">
              {xmlCategories.map(cat=>(
                <label key={cat} className="p-2 border rounded flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" checked={selectedCategories.includes(cat)} onChange={()=>toggleCategory(cat)} />
                  <span className="text-sm truncate">{cat}</span>
                </label>
              ))}
            </div>
            <div className="flex justify-end gap-2">
              <button className="px-3 py-2 bg-gray-200 rounded" onClick={()=>{
                setSelectedCategories(xmlCategories.slice());
              }}>–û–±–µ—Ä. –≤—Å—ñ</button>
              <button className="px-3 py-2 bg-gray-200 rounded" onClick={()=>setSelectedCategories([])}>–ó–Ω—è—Ç–∏ –≤—Å—ñ</button>
              <button className="px-3 py-2 bg-green-600 text-white rounded" onClick={importSelectedCategories}>–Ü–º–ø–æ—Ä—Ç—É–≤–∞—Ç–∏</button>
            </div>
          </div>
        </div>
      )}

      {/* MANUAL ADD MODAL */}
      {showAddModal && (
        <AddModal onClose={()=>setShowAddModal(false)} onSave={saveManualProduct} defaultSupplier={suppliers[0]||''} />
      )}

    </div>
  );
}

function AddModal({onClose,onSave,defaultSupplier}){
  const [name,setName] = useState('');
  const [supplier,setSupplier] = useState(defaultSupplier);
  const [basePrice,setBasePrice] = useState('');
  const [rrp,setRrp] = useState('');
  const [vendor,setVendor] = useState('');
  const [image,setImage] = useState('');
  const [category,setCategory] = useState('');

  return (
    <div className="fixed inset-0 flex items-center justify-center modal-bg z-50">
      <div className="bg-white rounded w-11/12 md:w-1/2 p-4">
        <div className="flex justify-between items-center mb-2">
          <h3 className="font-bold">–î–æ–¥–∞—Ç–∏ —Ç–æ–≤–∞—Ä –≤—Ä—É—á–Ω—É</h3>
          <button onClick={onClose}>‚úï</button>
        </div>
        <div className="space-y-2">
          <input id="add-name" value={name} onChange={e=>setName(e.target.value)} placeholder="–ù–∞–∑–≤–∞" className="w-full p-2 border rounded" />
          <input value={supplier} onChange={e=>setSupplier(e.target.value)} placeholder="–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫" className="w-full p-2 border rounded" />
          <div className="grid grid-cols-2 gap-2">
            <input value={basePrice} onChange={e=>setBasePrice(e.target.value)} placeholder="–ë–∞–∑–æ–≤–∞ —Ü—ñ–Ω–∞" className="p-2 border rounded" />
            <input value={rrp} onChange={e=>setRrp(e.target.value)} placeholder="–¶—ñ–Ω–∞ –ø—Ä–æ–¥–∞–∂—É" className="p-2 border rounded" />
          </div>
          <input value={vendor} onChange={e=>setVendor(e.target.value)} placeholder="–ë—Ä–µ–Ω–¥" className="w-full p-2 border rounded" />
          <input value={category} onChange={e=>setCategory(e.target.value)} placeholder="–ö–∞—Ç–µ–≥–æ—Ä—ñ—è" className="w-full p-2 border rounded" />
          <input value={image} onChange={e=>setImage(e.target.value)} placeholder="URL –∫–∞—Ä—Ç–∏–Ω–∫–∏ (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)" className="w-full p-2 border rounded" />
          <div className="flex justify-end gap-2">
            <button className="px-3 py-2 bg-gray-200 rounded" onClick={onClose}>–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            <button className="px-3 py-2 bg-blue-600 text-white rounded" onClick={()=>{
              if(!name){ alert('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É'); return; }
              onSave({
                name, supplier, basePrice: parseFloat(basePrice)||0, rrp: parseFloat(rrp)||parseFloat(basePrice)||0,
                vendor, image, available: true, category
              });
            }}>–ó–±–µ—Ä–µ–≥—Ç–∏</button>
          </div>
        </div>
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);

</script>
</body>
</html>
